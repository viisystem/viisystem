;
(function ($) {
    if (typeof window.jurakit === 'undefined') {
        window.jurakit = {};
    }

    jurakit.nestsortable = {
        // el #nestsortable-container
        init: function (el) {
            if (typeof el === 'undefined') {
                el = '.nestsortable-container';
            }

            $(el + ' > ol').nestedSortable({
                items: '.nestsortable-wrap',
                handle: '.nestsortable-item',
                toleranceElement: '> .nestsortable-item',
                helper:	'clone',
                opacity: .6,
                placeholder: 'placeholder',
                forcePlaceholderSize: true,
                maxLevels: 10,
                update: function(e, ui) {
                    $data = {
                        'itemId' : jurakit.nestsortable.getItemVal(ui.item.context),
                        'itemParent' : jurakit.nestsortable.getItemVal({'id':$('#'+ui.item.context.id).parents('li').attr('id')}),
                        'itemBefore' : jurakit.nestsortable.getItemVal(ui.item.context.previousSibling),
                        'itemAfter' : jurakit.nestsortable.getItemVal(ui.item.context.nextSibling)
                    };

                    //console.log(JSON.stringify($data));
                    //console.log('itemId:' + jurakit.nestsortable.getItemVal(ui.item.context));
                    //console.log('itemParent:' + jurakit.nestsortable.getItemVal({'id':$('#'+ui.item.context.id).parents('li').attr('id')}));
                    //console.log('itemBefore:' + jurakit.nestsortable.getItemVal(ui.item.context.previousSibling));
                    //console.log('itemAfter:' + jurakit.nestsortable.getItemVal(ui.item.context.nextSibling));

                    $.ajax({
                        url: $('#'+ui.item.context.id).attr('data-url'),
                        type: 'post',
                        data: $data,
                        dataType : 'json',
                        success: function($data) {
                            $(el).html($data.c);
                            jurakit.nestsortable.init();
                        }
                    });
                }
            });

            $('.nestsortable-item-close').unbind().on('click', function() {
                $(this).closest('li').toggleClass('mjs-nestedSortable-collapsed').toggleClass('mjs-nestedSortable-expanded');
                $(this).toggleClass('ui-icon-plusthick').toggleClass('ui-icon-minusthick');
            });
        },
        getItemVal: function (obj) {
            if (obj === null || obj.id === undefined) {
                return '';
            }

            return (jQuery.type(obj) === "string")
                ? obj.replace('nestsortable-item-', '')
                : obj.id.replace('nestsortable-item-', '');
        }
    }
})(jQuery);

$(function(){
    jurakit.nestsortable.init();
});